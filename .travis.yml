language: php
sudo: false
dist: trusty

cache:
  directories:
    - vendor
    - $HOME/.composer/cache

before_install:
  - phpenv config-rm xdebug.ini || true
  - |
    if [ "x$COVERAGE" == "xyes" ]; then
      pecl install pcov-1.0.0
    fi

install:
  - rm composer.lock
  - travis_retry composer -n update --prefer-dist

script:
  - vendor/bin/ecs check --config=ecs.yml .
  - |
    if [ "x$COVERAGE" == "xyes" ]; then
       ./vendor/bin/phpunit --configuration phpunit.travis.xml --coverage-clover build/logs/clover.xml
    else
       ./vendor/bin/phpunit --configuration phpunit.travis.xml
    fi

after_success:
  - |
    if [ "x$COVERAGE" == "xyes" ]; then
      travis_retry vendor/bin/php-coveralls -v
    fi

matrix:
  fast_finish: true
  allow_failures:
    - php: "7.4snapshot"
  include:
    - stage: Test
      php: "7.2"
      env: DB=pgsql POSTGRESQL_VERSION=11.0
      sudo: required
      services:
        - docker
      before_script:
        - bash ./tests/travis/install-postgres-11.sh
        - bash ./tests/travis/create-database.sh
    - stage: Test
      php: "7.3"
      env: DB=pgsql POSTGRESQL_VERSION=9.2 COVERAGE=yes
      services:
        - postgresql
      addons:
        postgresql: "9.2"
      before_script:
        - bash ./tests/travis/create-database.sh
    - stage: Test
      php: "7.3"
      env: DB=pgsql POSTGRESQL_VERSION=9.3 COVERAGE=yes
      services:
        - postgresql
      addons:
        postgresql: "9.3"
      before_script:
        - bash ./tests/travis/create-database.sh
    - stage: Test
      php: "7.3"
      env: DB=pgsql POSTGRESQL_VERSION=9.4 COVERAGE=yes
      services:
        - postgresql
      addons:
        postgresql: "9.4"
      before_script:
        - bash ./tests/travis/create-database.sh
    - stage: Test
      php: "7.3"
      env: DB=pgsql POSTGRESQL_VERSION=9.5 COVERAGE=yes
      services:
        - postgresql
      addons:
        postgresql: "9.5"
      before_script:
        - bash ./tests/travis/create-database.sh
    - stage: Test
      php: "7.3"
      env: DB=pgsql POSTGRESQL_VERSION=9.6 COVERAGE=yes
      services:
        - postgresql
      addons:
        postgresql: "9.6"
      before_script:
          - bash ./tests/travis/create-database.sh
    - stage: Test
      php: "7.3"
      env: DB=pgsql POSTGRESQL_VERSION=10.0 COVERAGE=yes
      sudo: required
      services:
        - postgresql
      addons:
        postgresql: "9.6"
      before_script:
        - bash ./tests/travis/install-postgres-10.sh
        - bash ./tests/travis/create-database.sh
    - stage: Test
      php: "7.3"
      env: DB=pgsql POSTGRESQL_VERSION=11.0 COVERAGE=yes
      sudo: required
      services:
        - docker
      before_script:
        - bash ./tests/travis/install-postgres-11.sh
        - bash ./tests/travis/create-database.sh
    - stage: Test
      php: "7.4snapshot"
      env: DB=pgsql POSTGRESQL_VERSION=11.0
      sudo: required
      services:
        - docker
      before_script:
        - bash ./tests/travis/install-postgres-11.sh
        - bash ./tests/travis/create-database.sh
